## EMQX Configuration for OpenMoxie
## =================================

## Node Configuration
node.name = emqx@127.0.0.1
node.cookie = emqxsecretcookie
node.data_dir = /opt/emqx/data
node.etc_dir = /opt/emqx/etc

## Cluster Configuration
cluster.discovery = static
cluster.static.seeds = emqx@127.0.0.1

## MQTT Configuration
mqtt {
    ## MQTT listeners
    listeners.tcp.default {
        bind = "0.0.0.0:1883"
        max_connections = 1000
        max_conn_rate = 1000
    }
    
    listeners.ssl.default {
        bind = "0.0.0.0:8883"
        max_connections = 1000
        max_conn_rate = 1000
        ssl_options {
            keyfile = "/opt/emqx/etc/certs/key.pem"
            certfile = "/opt/emqx/etc/certs/cert.pem"
            cacertfile = "/opt/emqx/etc/certs/cacert.pem"
        }
    }
    
    ## MQTT protocol settings
    max_packet_size = 1MB
    max_clientid_len = 65535
    max_topic_levels = 128
    max_qos_allowed = 2
    max_topic_alias = 65535
    retain_available = true
    wildcard_subscription = true
    shared_subscription = true
    exclusive_subscription = false
    ignore_loop_deliver = false
    strict_mode = false
    
    ## Message settings
    max_inflight = 32
    max_awaiting_rel = 100
    await_rel_timeout = 300s
    session_expiry_interval = 2h
    max_mqueue_len = 1000
    mqueue_priorities = none
    mqueue_default_priority = lowest
    mqueue_store_qos0 = true
    
    ## Keep alive settings
    keepalive_backoff = 0.75
    max_keepalive = 65535
}

## Authentication Configuration
## Allow anonymous access for monitoring
auth.1 = {mechanism = anonymous, enable = true}

## Authorization Configuration
## Allow all operations for monitoring
authorization.sources = [
    {type = file, enable = true, rules = [
        {permission = allow, action = all, topics = ["#"]}
    ]}
]

## Logging Configuration
log {
    ## Console logging
    console_handler {
        enable = true
        level = debug
        time_offset = "+00:00"
        charset = utf8
        formatter = text
        single_line = false
        sync_mode_qlen = 100
        drop_mode_qlen = 3000
        flush_qlen = 8000
        overload_kill {
            enable = true
            max_heap_size = 1MB
            kill_restart_after = 2s
        }
    }
    
    ## File logging
    file_handlers {
        default {
            enable = false
            level = debug
            time_offset = "+00:00"
            charset = utf8
            formatter = text
            single_line = false
            sync_mode_qlen = 100
            drop_mode_qlen = 3000
            flush_qlen = 8000
            rotation {
                enable = true
                max_size = 50MB
                count = 5
            }
            rotation_on_size = 100MB
            rotation_count = 5
            max_depth = 100
            overload_kill {
                enable = true
                max_heap_size = 1MB
                kill_restart_after = 2s
            }
        }
    }
    
    ## Logger configuration
    logger {
        level = debug
        handlers = [console_handler]
    }
}

## Dashboard Configuration
dashboard {
    listeners.http {
        bind = 18083
    }
    default_username = admin
    default_password = public
}

## Management API
management {
    listeners.http {
        bind = 8081
    }
}

## Prometheus Configuration
prometheus {
    enable = true
    push_gateway_server = "http://127.0.0.1:9091"
    interval = 15s
    enable_basic_auth = false
    username = admin
    password = public
}

## Metrics Configuration
metrics {
    enable = true
    interval = 15s
}

## System Configuration
sysmon {
    vm {
        high_watermark = 0.8
        low_watermark = 0.6
    }
    os {
        mem_check_interval = 60s
        sys_mem_high_watermark = 0.8
        proc_mem_high_watermark = 0.8
    }
}

## Zone Configuration
zones {
    default {
        mqtt {
            max_packet_size = 1MB
            max_clientid_len = 65535
            max_topic_levels = 128
            max_qos_allowed = 2
            max_topic_alias = 65535
            retain_available = true
            wildcard_subscription = true
            shared_subscription = true
            exclusive_subscription = false
            ignore_loop_deliver = false
            strict_mode = false
            max_inflight = 32
            max_awaiting_rel = 100
            await_rel_timeout = 300s
            session_expiry_interval = 2h
            max_mqueue_len = 1000
            mqueue_priorities = none
            mqueue_default_priority = lowest
            mqueue_store_qos0 = true
            keepalive_backoff = 0.75
            max_keepalive = 65535
        }
    }
}
